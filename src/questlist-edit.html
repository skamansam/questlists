<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="questlists-page-behavior.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="questlists-theme.html">
<link rel="import" href="util.html">

<!--
`<questlist-edit>` handles editing the preferences for lists. Also creates a new list
if no `list-id` is given. Handles shwing the dialog and getting/setting the prefs.
Use the `config` attribute to get the prefs.

The config data is stored in Firebase at /questlists/config/{{listId}}
-->
<dom-module id="questlist-edit">
  <template>
    <style include="shared-styles"></style>
    <style include="questlists-theme"></style>
    <style>
       :host {
        display: block;
      }
      :host[hidden]{
        display: none
      }
      #dialog {
        padding: 0px;
      }
    </style>
    <firebase-document sequentialtransactions log disabled path="/list_configs/[[listId]]" id="config_doc" data="{{config}}">
    </firebase-document>
    <paper-card id="edit_card" paper-material elevation="2">
      <h2><span>{{config_data.name}}</span> List</h2>
      <paper-input label="Created By" id="created_by" value="[[listId]]" disabled></paper-input>
      <paper-input label="List ID" id="list_id" value="[[listId]]" disabled></paper-input>
      <paper-input autofocus label="Title" id="title" value="{{config_data.title}}"></paper-input>
      <paper-textarea label="Description" type="text" id="description" value="{{config_data.description}}"></paper-textarea>
      <div class="buttons">
        <paper-button on-tap="onCanceled">Cancel</paper-button>
        <paper-button on-tap="onConfirmed" default>Accept</paper-button>
      </div>
    </paper-card>

  </template>
  <script>
    class QuestlistsEdit extends Mixin(Polymer.Element).with() {
      static get is() { return 'questlist-edit'; }

      static get properties() {
        return {
          /** The Firebase ID of the config. */
          listId: {
            type: String,
            notify: true,
            observer: '_list_id_changed'
          },
          user: Object,
          /** The config object. */
          config: {
            type: Object,
            notify: true,
            observer: '_config_changed',
            value: {}
          },

          /** The inital data */
          config_data: {
            type: Object,
            value: {
              title: "New",
              created_by: null,
              description: 'New Questlist',
              image: 'some image',
              image_alt: 'awesomeimage no.1',
              color: '#00ccff',
              states: {
                active: {
                  hidden: false,
                  style: 'font-weight: bold;'
                },
                inactive: {
                  hidden: true,
                  style: 'font-weight: bold;'
                },
                completed: {
                  hidden: false,
                  style: 'font-weight: normal;'
                },
                partial: {
                  hidden: false,
                  style: 'font-weight: bold; font-style: italics;'
                }
              }
            }
          }
        }
      }
      connectedCallback() {
        super.connectedCallback()
        const root = Polymer.dom(this.root);
        const first = root.firstChild;
        Array.from(root.querySelectorAll('paper-dialog'))
          .reverse()
          .forEach(dialog => root.insertBefore(dialog, first));
      }


      /** Show the settings window. */
      show(id) {
        //this.$.config_doc.path = `/list_configs/${this.listId}`
        //if(!this.config){
        console.log(this.$.config_doc.path);
        this.$.config_doc.removeAttribute('disabled');

        this.config_data.created_by = (this.config_data.created_by || this.user.uid);
        //this.$.config_doc.getStoredValue(this.$.config_doc.path)
        //}
        //console.log(this.$.config_doc.path)
        this.$.dialog.positionTarget = document.body;
        this.$.dialog.open();
      }

      /** event handler that fires when config data is changed*/
      _config_changed(new_val) {
        console.info("Config Changed: ", new_val);
      }

      /** event handler that fires when config data is changed*/
      _list_id_changed(new_val) {
        console.info("List ID updated to: ", new_val);
      }

      /** What happens when the dialog is closed. Updates the config in Firebase.
      Also fires two events: `canceled` and `confirmed`. */
      _closed(evt) {
        if (evt.detail.confirmed) this.onConfirmed(); else this.onCanceled();
      }

      /* Called when dialog is confirmed. Saves data. Fires 'confirmed' event after successfully saving.*/
      onConfirmed() {
        //this.$.config_doc.removeAttribute('disabled')
        console.info(this.$.config_doc.path, this.listId, this.config);
        this.$.config_doc.setStoredValue(this.$.config_doc.path, this.config).then(function (config) {
          console.info("SAVING: ", config);
        }.bind(this), function (reason) {
          console.error("ERROR SAVING: ", reason);
        }.bind(this));
        /*if(this.listId){
          this.config.$key = this.listId
        } else {
          this.$.config_doc.save('/list_configs', this.listId).then(function(val){
            console.info("RESOLVED: ", val)
          },function(reason){
            console.error("FAILED: ", reason)
          })
          this.fire('confirmed', this.config)
        }*/
      }

      /* Called when dialog is open. Fires `canceled` event */
      onCanceled(evt) {
        this.dispatchEvent(new CustomEvent('cancel', evt));
      }

      /* Called when dialog is open. Fires `opened` event */
      _opened(evt) {
        if (evt.target.withBackdrop) {
           evt.target.parentNode.insertBefore(evt.target.backdropElement, evt.target);
        }

        this.dispatchEvent(new CustomEvent('opened', evt));
      }

    }

    window.customElements.define(QuestlistsEdit.is, QuestlistsEdit);
  </script>
</dom-module>