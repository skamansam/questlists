<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/iron-icons/image-icons.html">
<link rel="import" href="../bower_components/paper-styles/typography.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="questlists-page-behavior.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="questlists-theme.html">
<link rel="import" href="util.html">

<!--
`<questlist-edit>` handles editing the preferences for lists. Also creates a new list
if no `list-id` is given. Handles shwing the dialog and getting/setting the prefs.
Use the `config` attribute to get the prefs.

The config data is stored in Firebase at /questlists/config/{{listId}}
-->
<dom-module id="questlist-edit">
  <template>
    <style include="shared-styles"></style>
    <style include="questlists-theme"></style>
    <style>
       :host {
        display: block;
      }

       :host[hidden] {
        display: none
      }

      #dialog {
        padding: 0px;
      }
      #background-image-changer{
        float: right;
        height: 33px;
        color: var(--theme-secondary-color)
      }
    </style>
    <firebase-document log disabled path="/list_configs/[[listId]]/" id="config_doc" on-save="_save_test" data="{{the_data}}">
    </firebase-document>
    <paper-card id="edit_card" paper-material elevation="2">
      <paper-icon-button title="Set Background Image" id="background-image-changer" icon="image:image" value="[[default_config.created_by]]"></paper-icon-button>
      <h2><span>{{default_config.title}}</span> List</h2>
      <paper-input label="Created By" id="created_by" value="[[default_config.created_by]]" disabled></paper-input>
      <paper-input label="List ID" id="list_id" value="[[listId]]" disabled></paper-input>
      <paper-input autofocus label="Title" id="title" value="{{default_config.title}}"></paper-input>
      <paper-textarea label="Description" type="text" id="description" value="{{default_config.description}}"></paper-textarea>
      <div class="buttons">
        <paper-button on-tap="onCanceled">Cancel</paper-button>
        <paper-button on-tap="onConfirmed" default>Accept</paper-button>
      </div>
    </paper-card>

  </template>
  <script>
    class QuestlistsEdit extends Mixin(Polymer.Element).with() {
      static get is() { return 'questlist-edit'; }

      static get properties() {
        return {
          /** The Firebase ID of the config. */
          listId: {
            type: String,
            notify: true,
            observer: '_list_id_changed'
          },

          /** The author of this item, if the config object doesn't already have it.*/
          user: {
            type: Object,
            observer: '_user_changed'
          },

          /** The config object that is passed in. We don't change this internally. */
          config: {
            type: Object,
            notify: true,
            observer: '_config_changed',
            value: {}
          },

          /** The inital data. This is the internal state representation. We don't change the passed in config object, so we can reset the data! */
          default_config: {
            type: Object,
            value: {
              title: "New",
              created_by: null,
              description: 'New Questlist',
              image: 'some image',
              image_alt: 'awesomeimage no.1',
              color: '#00ccff',
              states: {
                active: {
                  hidden: false,
                  style: 'font-weight: bold;'
                },
                inactive: {
                  hidden: true,
                  style: 'font-weight: bold;'
                },
                completed: {
                  hidden: false,
                  style: 'font-weight: normal;'
                },
                partial: {
                  hidden: false,
                  style: 'font-weight: bold; font-style: italics;'
                }
              }
            }
          }
        }
      }
      _save_test(a,b,c){
        console.log("SAVED!!!", a,b,c)
      }
      connectedCallback() {
        super.connectedCallback()
      }

      _user_changed(new_user) {
        if (!new_user) return
        this._set_uid(new_user)
      }

      /** Show the settings window. */
      show(id) {
        console.info('questlist-edit: show()',id)
        //this.$.config_doc.path = `/list_configs/${this.listId}`
        //if(!this.config){
        //console.log(this.$.config_doc.path);
        //this.$.config_doc.removeAttribute('disabled');

        if(this.default_config.created_by === null)
          this.default_config.created_by = this.user.uid;
        //this.$.config_doc.getStoredValue(this.$.config_doc.path)
        //}
        //console.log(this.$.config_doc.path)
      }

      _set_uid(user) {
        if (this.default_config.created_by == null) {
          this.set('default_config.created_by', user.uid)
        }
      }

      /** event handler that fires when config data is changed.
        We want to make sure our values are at least what they should be, as listed in default_config, so we merge the new values into the
        default data.
      */
      _config_changed(new_val) {
        if (!new_val || Object.keys(new_val).length == 0) return
        this.default_config = Object.assign({}, this.default_config, new_val)
        this._set_uid(this.user)
      }

      _get_stored_data(){
        this.$.config_doc.removeAttribute('disabled');
        this.$.config_doc.getStoredValue(this.$.config_doc.path).then(()=>{
          this.$.config_doc.addAttribute('disabled');
        })
      }

      /** event handler that fires when config data is changed*/
      _list_id_changed(new_val) {
        if (!new_val) return
        console.info("questlist-edit: List ID updated to: ", new_val);
      }

      /* Called when dialog is confirmed. Saves data. Fires 'confirmed' event after successfully saving.*/
      onConfirmed() {
        //this.$.config_doc.removeAttribute('disabled')
        //let updated_config = this._changed_values(this.default_config, this.config)
        console.info('questlist-edit: updating',this.$.config_doc.path, this.listId, this.default_config);
        this.$.config_doc.setStoredValue(this.$.config_doc.path, this.default_config).then((config, a, b, c) => {
          console.info("questlist-edit: SAVING: ", config, a, b, c);
          debugger
          this.dispatchEvent(new CustomEvent('confirmed', { detail: this.default_config }));
        }, (reason) => {
          console.error("questlist-edit: ERROR SAVING: ", reason);
        })
        /*if(this.listId){
          this.config.$key = this.listId
        } else {
          this.$.config_doc.save('/list_configs', this.listId).then(function(val){
            console.info("RESOLVED: ", val)
          },function(reason){
            console.error("FAILED: ", reason)
          })
          this.fire('confirmed', this.config)
        }*/
      }

      /* Called when dialog is open. Fires `canceled` event */
      onCanceled(evt) {
        this.dispatchEvent(new CustomEvent('cancel', evt));
      }

      /* Called when dialog is open. Fires `opened` event */
      _opened(evt) {
        this.dispatchEvent(new CustomEvent('opened', evt));
      }

      _changed_values(old_obj, changed_obj) {
        let changes = {}
        for (let key in changed_obj)
          if (old_obj[key] !== changed_obj[key])
            changes[key] = changed_obj[key]
        return changes
      }

    }

    window.customElements.define(QuestlistsEdit.is, QuestlistsEdit);
  </script>
</dom-module>
